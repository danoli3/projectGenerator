name: build-macos

on:
  push:
    paths-ignore:
      - '**/README.md'
  pull_request:
    paths-ignore:
      - '**/README.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-osx:
    runs-on: macos-13
    strategy:
      matrix:
        cfg:
          - {target: osx}
    env:
      TARGET: ${{ matrix.cfg.target }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 16
      - name: Setup
        run: ./scripts/osx/setup_environment.sh
      - name: Determine Release
        id: vars
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "release=nightly" >> $GITHUB_ENV
            echo "prerelease=false" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/bleeding" ]]; then
            echo "release=bleeding" >> $GITHUB_ENV
            echo "prerelease=true" >> $GITHUB_ENV
          fi
      # - name: Build CMDLINE
      #   run: ./scripts/osx/build_cmdline.sh
      # - name: Build frontend
      #   run: ./scripts/osx/build_frontend.sh
      - name: Setup CI setup environment
        run: ./scripts/osx/ci_install_core.sh
      - name: Build
        run: ./scripts/osx/ci_build_pg.sh
        env:
          DEVELOPER_DIR: "/Applications/Xcode_15.0.1.app/Contents/Developer"
          SDKROOT: "/Applications/Xcode_15.0.1.app/Contents/DeveloperPlatforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"
          GA_CI_SECRET: ${{ secrets.CI_SECRET }}
          CERTIFICATE_OSX_APPLICATION: ${{ secrets.CERTIFICATE_OSX_APPLICATION }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
          GA_APPLE_USERNAME: ${{ secrets.GA_APPLE_USERNAME }}
          GA_APPLE_PASS: ${{ secrets.GA_APPLE_PASS }}
          GA_NOTARIZE_PROVIDER: ${{ secrets.GA_NOTARIZE_PROVIDER }}
      - name: List output directory
        run: ls -lah /
      - name: Update Release x86_64
        if: github.repository == 'openframeworks/projectGenerator' && github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/bleeding')
        uses: IsaacShelton/update-existing-release@v1.3.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.release }}
          release: ${{ env.release }}
          prerelease: ${{ env.prerelease }}
          replace: false
          files: ../openFrameworks/apps/projectGenerator/frontend/dist/projectGenerator-osx.zip

